dist: xenial
services:
  - docker
addons:
  sonarcloud:
    organization: "ictu"
  apt:
    packages:
      - libgconf-2-4  # For cypress
jobs:
  include:
    - stage: test
      name: "Collector"
      language: python
      python: 3.7
      install:
      - cd components/collector
      - pip install -r requirements.txt -r requirements-dev.txt
      script:
      - ci/unittest.sh
      - ci/quality.sh
    - name: "Server"
      language: python
      python: 3.7
      install:
      - cd components/server
      - pip install -r requirements.txt -r requirements-dev.txt
      script:
      - ci/unittest.sh
      - ci/quality.sh
    - name: "Frontend"
      language: node_js
      node_js: 10
      install:
      - cd components/frontend
      - npm install
      script:
      - npm test
    - name: "UI-tests"
      language: node_js
      node_js: 10
      install:
      - docker-compose build
      - cd components/art && npm install --save-dev && cd ../..
      script:
      - docker-compose up -d
      - cd components/art && npx cypress run
    - name: "SonarQube"
      language: python
      python: 3.7
      before_install:
      - nvm install 10
      - git fetch --unshallow
      install:
      - cd components/collector
      - pip install -r requirements.txt -r requirements-dev.txt
      - cd ../../components/server
      - pip install -r requirements.txt -r requirements-dev.txt
      - cd ../../components/frontend
      - npm install
      - cd ../..
      script:
      - cd components/collector
      - mkdir build
      - ci/unittest.sh
      - nosetests --nocapture --with-xunit --xunit-file=build/nosetests.xml tests/unittests
      - cd ../../components/server
      - mkdir build
      - ci/unittest.sh
      - nosetests --nocapture --with-xunit --xunit-file=build/nosetests.xml tests/unittests
      - cd ../../components/frontend
      - npm test
      - cd ../..
      - touch components/__init__.py
      - touch components/server/__init__.py
      - touch components/server/src/__init__.py
      - touch components/collector/__init__.py
      - touch components/collector/src/__init__.py
      - sonar-scanner
