version: 2.1

jobs:
  unittest_backend:
    docker:
      - image: cimg/python:3.10.4
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    parallelism: 4
    steps:
      - checkout
      - run: |
          case $CIRCLE_NODE_INDEX in
            0) component=collector;;
            1) component=notifier;;
            2) component=server;;
            3) component=shared_python;;
          esac
          cd components/$component
          python -m venv venv
          . venv/bin/activate
          pip install wheel
          pip install --progress-bar off -r requirements.txt -r requirements-dev.txt
          if [ -f "requirements-internal.txt" ]; then
            pip install --progress-bar off -r requirements-internal.txt
          fi
          ci/unittest.sh
          ci/quality.sh

  unittest_frontend:
    docker:
      - image: cimg/node:lts
        auth:
          username: $DOCKERHUB_USERNAME
          password: $DOCKERHUB_PASSWORD
    steps:
      - checkout
      - run:
          command: |
            cd components/frontend
            npm install
            npm test

  unittest_docs:
    docker:
      - image: cimg/python:3.10.4-node
    steps:
      - checkout
      - run: |
          cd docs
          python -m venv venv
          . venv/bin/activate
          pip install wheel
          pip install --progress-bar off -r requirements-dev.txt
          npm install
          ci/unittest.sh
          ci/quality.sh

  application_tests:
    machine:
      image: ubuntu-2004:current
    parallelism: 1
    steps:
      - checkout
      - run: |
          export ENV=ci
          export COMPOSE_PATH_SEPARATOR=':'
          export COMPOSE_FILE=docker/docker-compose.yml:docker/docker-compose.ci.yml
          docker-compose build && docker-compose up -d
          docker run -it -w `pwd` -v `pwd`:`pwd` --network=container:quality-time-www-1 python:3.10.4-bullseye tests/application_tests/ci/test.sh

  feature_tests:
    machine:
      image: ubuntu-2004:current
    parallelism: 1
    steps:
      - checkout
      - run: |
          ./tests/feature_tests/ci/test.sh
      - store_artifacts:
          path: build

workflows:
  version: 2
  build_test:
    jobs:
      - application_tests:
          context: QualityTime
      - feature_tests:
          context: QualityTime
      - unittest_backend:
          context: QualityTime
      - unittest_frontend:
          context: QualityTime
      - unittest_docs:
          context: QualityTime
