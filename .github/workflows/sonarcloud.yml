---
name: SonarCloud

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  sonarcloud:
    runs-on: ubuntu-latest
    env:
      SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
    steps:
      - name: Login to DockerHub
        if: env.SONAR_TOKEN != null
        uses: docker/login-action@v3.7.0
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - uses: actions/checkout@v6.0.2
        if: env.SONAR_TOKEN != null
        with:
          fetch-depth: 0 # Disabling shallow clone is recommended for improving relevancy of reporting
      - name: Install uv
        if: env.SONAR_TOKEN != null
        uses: astral-sh/setup-uv@v7.2.1
        with:
          version-file: tools/requirements-uv.txt
      - name: Set up Node
        if: env.SONAR_TOKEN != null
        uses: actions/setup-node@v6.2.0
        with:
          node-version-file: components/frontend/package.json
      - name: Collector
        if: env.SONAR_TOKEN != null
        working-directory: components/collector
        run: |
          uvx --from=$(cat $GITHUB_WORKSPACE/tools/requirements-just.txt) just test
          export PYTHONPATH=`python -c 'import sys;print(":".join(sys.argv[1:]))' src $PYTHONPATH`
          uv run --with=unittest-xml-reporting -m xmlrunner --output-file build/unittests.xml
      - name: Notifier
        if: env.SONAR_TOKEN != null
        working-directory: components/notifier
        run: |
          uvx --from=$(cat $GITHUB_WORKSPACE/tools/requirements-just.txt) just test
          export PYTHONPATH=`python -c 'import sys;print(":".join(sys.argv[1:]))' src $PYTHONPATH`
          uv run --with=unittest-xml-reporting -m xmlrunner --output-file build/unittests.xml
      - name: API-server
        if: env.SONAR_TOKEN != null
        working-directory: components/api_server
        run: |
          uvx --from=$(cat $GITHUB_WORKSPACE/tools/requirements-just.txt) just test
          export PYTHONPATH=`python -c 'import sys;print(":".join(sys.argv[1:]))' src $PYTHONPATH`
          uv run --with=unittest-xml-reporting -m xmlrunner --output-file build/unittests.xml
      - name: Shared Code
        if: env.SONAR_TOKEN != null
        working-directory: components/shared_code
        run: |
          uvx --from=$(cat $GITHUB_WORKSPACE/tools/requirements-just.txt) just test
          export PYTHONPATH=`python -c 'import sys;print(":".join(sys.argv[1:]))' src $PYTHONPATH`
          uv run --with=unittest-xml-reporting -m xmlrunner --output-file build/unittests.xml
      - name: Frontend
        if: env.SONAR_TOKEN != null
        working-directory: components/frontend
        env:
          CI: true
        run: uvx --from=$(cat $GITHUB_WORKSPACE/tools/requirements-just.txt) just test cov
      - name: Create packages
        if: env.SONAR_TOKEN != null
        run: |
          touch components/__init__.py
          touch components/api_server/__init__.py
          touch components/api_server/src/__init__.py
          touch components/collector/__init__.py
          touch components/collector/src/__init__.py
          touch components/notifier/__init__.py
          touch components/notifier/src/__init__.py
          touch components/shared_code/__init__.py
          touch components/shared_code/src/__init__.py
      - name: Sonarcloud scan
        if: env.SONAR_TOKEN != null
        uses: sonarsource/sonarqube-scan-action@v7.0.0
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
